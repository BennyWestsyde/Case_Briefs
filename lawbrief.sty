\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{lawbrief}[2025/07/22 Law School Case Briefs]

\RequirePackage{xparse}
\RequirePackage{pgfkeys}
\RequirePackage{fancyhdr}
\RequirePackage{geometry}
\RequirePackage{titlesec}
\RequirePackage{etoolbox}
\RequirePackage{listofitems}
\RequirePackage{hyperref}
\RequirePackage{makeidx}
\makeindex

% Page layout
\geometry{margin=1in}
\setlength{\parindent}{0pt}


% Declare brief keys
\pgfkeys{
	/brief/.is family,
	/brief/.unknown/.code = {},
	/brief/subject/.initial = ,
	/brief/plaintiff/.initial = ,
	/brief/defendant/.initial = ,
	/brief/citation/.initial = ,
	/brief/course/.initial = ,
	/brief/facts/.initial = ,
	/brief/procedure/.initial = ,
	/brief/issue/.initial = ,
	/brief/holding/.initial = ,
    /brief/principle/.initial = ,
	/brief/reasoning/.initial = ,
	/brief/opinions/.initial = ,
	/brief/label/.initial = ,
	/brief/notes/.initial = ,
}



\newcommand{\indexsubjects}[1]{%
		\edef\unwrapped{\unexpanded\expandafter{\romannumeral-`0#1}}%
		\readlist*\subjectlist{\unwrapped}%
		\foreachitem\z\in\subjectlist[]{\index{\z}}%
}


\newcommand{\includecases}{
	\immediate\write18{find ./Cases -name "*.tex" | sort > casefiles.txt}
	\newread\casefile
	\openin\casefile=casefiles.txt
	\loop
		\read\casefile to \filename
		\unless\ifeof\casefile
			\IfFileExists{\filename}{\subfile{\filename}}{}
	\repeat
	\closein\casefile
}

\newcommand{\CaseRef}[1]{
    \hyperref[case:#1]{\textit{#1}}
}



% Main command
\NewDocumentCommand{\NewBrief}{m}{

	% Start each brief on a new page
	\newpage
	\pgfkeys{/brief, #1}

	
	\edef\currentsubject{\unexpanded\expandafter{\pgfkeysvalueof{/brief/subject}}}
	\edef\currentplaintiff{\unexpanded\expandafter{\pgfkeysvalueof{/brief/plaintiff}}}
	\edef\currentdefendant{\unexpanded\expandafter{\pgfkeysvalueof{/brief/defendant}}}
	\edef\currentcitation{\unexpanded\expandafter{\pgfkeysvalueof{/brief/citation}}}
	\edef\currentcourse{\unexpanded\expandafter{\pgfkeysvalueof{/brief/course}}}
    \edef\currentfacts{\unexpanded\expandafter{\pgfkeysvalueof{/brief/facts}}}
    \edef\currentprocedure{\unexpanded\expandafter{\pgfkeysvalueof{/brief/procedure}}}
    \edef\currentissue{\unexpanded\expandafter{\pgfkeysvalueof{/brief/issue}}}
    \edef\currentholding{\unexpanded\expandafter{\pgfkeysvalueof{/brief/holding}}}
    \edef\currentprinciple{\unexpanded\expandafter{\pgfkeysvalueof{/brief/principle}}}
    \edef\currentreasoning{\unexpanded\expandafter{\pgfkeysvalueof{/brief/reasoning}}}
    \edef\currentopinions{\unexpanded\expandafter{\pgfkeysvalueof{/brief/opinions}}}
    \edef\currentlabel{\unexpanded\expandafter{\pgfkeysvalueof{/brief/label}}}
	\edef\currentnotes{\unexpanded\expandafter{\pgfkeysvalueof{/brief/notes}}}


	% PDF metadata
	\hypersetup{
		pdftitle={\currentplaintiff\ v.\ \currentdefendant},
		pdfsubject={\currentsubject},
		pdfkeywords={\currentsubject}
	}

	
		% Header and footer
        \fancyhf{}
        \fancyhead[L]{\currentcitation}
        \fancyhead[R]{\currentsubject}
        \fancyfoot[C]{\thepage}
        \thispagestyle{fancy}



	\addcontentsline{toc}{section}{\hyperref[\currentlabel]{\currentplaintiff\ v.\ \currentdefendant}} % Add to TOC


	% Optional label for referencing
	\pgfkeysifdefined{/brief/label}{%
	\phantomsection % create a link anchor here
		\label{\currentlabel}%
	}{}

	% Title block
	\begin{center}
		\begin{Huge}
			\currentplaintiff\ v.\ \currentdefendant
		\end{Huge}\\
		\begin{large}
			\currentcitation
		\end{large}
	\end{center}

	% Display course
	\section*{Course}
	\ifblank{\currentcourse}{%
			\textit{No course specified.}
	}{
		\currentcourse
		\indexsubjects{\currentcourse}
	}

	% Display subject
	\section*{Keyword Subject}
	\ifblank{\currentsubject}{%
			\textit{No subject specified.}
	}{
			\currentsubject
			\indexsubjects{\currentsubject}
	}

	\section*{Facts}
    \ifblank{\currentfacts}{%
        \textit{No facts provided.}
    }{
        \currentfacts
    }

	\section*{Procedural History}
    \ifblank{\currentprocedure}{%
        \textit{No procedural history provided.}
    }{
        \currentprocedure
    }

	\section*{Issue}
    \ifblank{\currentissue}{%
        \textit{No issue provided.}
    }{
    	\currentissue
    }

	\section*{Holding: \currentholding}
    \ifblank{\currentprinciple}{%
    }{
        \subsection*{Principle}
        \currentprinciple
    }

	\section*{Reasoning}
    \ifblank{\currentreasoning}{%
        \textit{No reasoning provided.}
    }{
        \currentreasoning
    }

	\section*{Separate Opinions}
    \ifblank{\currentopinions}{%
        \textit{No separate opinions provided.}
    }{
        \currentopinions
    }

	\section*{Notes}
    \ifblank{\currentnotes}{%
        \textit{No notes provided.}
    }{
        \currentnotes
    }
}
