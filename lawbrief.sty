\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{lawbrief}[2025/07/22 Law School Case Briefs - No Glossary]

\RequirePackage{xparse}
\RequirePackage{pgfkeys}
\RequirePackage{fancyhdr}
\RequirePackage{hyperref}
\RequirePackage{geometry}
\RequirePackage{titlesec}
\RequirePackage{etoolbox}
\RequirePackage{listofitems}

% Page layout
\geometry{margin=1in}
\setlength{\parindent}{0pt}

% Declare brief keys
\pgfkeys{
  /brief/.is family,
  /brief/.unknown/.code = {},
  /brief/subject/.initial = ,
  /brief/plaintiff/.initial = ,
  /brief/defendant/.initial = ,
  /brief/citation/.initial = ,
  /brief/facts/.initial = ,
  /brief/procedure/.initial = ,
  /brief/issue/.initial = ,
  /brief/holding/.initial = ,
  /brief/reasoning/.initial = ,
  /brief/opinions/.initial = ,
  /brief/label/.initial = ,
}


\RequirePackage{listofitems}
\RequirePackage{makeidx}
\makeindex

\newcommand{\indexsubjects}[1]{%
    \edef\unwrapped{\unexpanded\expandafter{\romannumeral-`0#1}}%
    \readlist*\subjectlist{\unwrapped}%
    \foreachitem\z\in\subjectlist[]{\index{\z}}%
}






% Main command
\NewDocumentCommand{\NewBrief}{m}{
  \pgfkeys{/brief, #1}

  % Safely extract values
  \edef\currentsubject{\unexpanded\expandafter{\pgfkeysvalueof{/brief/subject}}}
  \edef\currentplaintiff{\unexpanded\expandafter{\pgfkeysvalueof{/brief/plaintiff}}}
  \edef\currentdefendant{\unexpanded\expandafter{\pgfkeysvalueof{/brief/defendant}}}
  \edef\currentcitation{\unexpanded\expandafter{\pgfkeysvalueof{/brief/citation}}}

  % PDF metadata
  \hypersetup{
    pdftitle={\currentplaintiff\ v.\ \currentdefendant},
    pdfsubject={\currentsubject},
    pdfkeywords={\currentsubject}
  }

  

  % Start each brief on a new page
  \newpage
  \pagestyle{fancy}
  \fancyhead[L]{\currentcitation}
  \fancyhead[R]{\currentsubject}
  \fancyfoot[C]{\thepage}

  % Optional label for referencing
  \pgfkeysifdefined{/brief/label}{%
  \phantomsection % create a link anchor here
    \label{\pgfkeysvalueof{/brief/label}}%
  }{}

  % Title block
  \begin{center}
    \begin{Huge}
      \currentplaintiff\ v.\ \currentdefendant
    \end{Huge}\\
    \begin{large}
      \currentcitation
    \end{large}
  \end{center}

  % Display subject
  \section*{Keyword Subject}
  \ifblank{\currentsubject}{%
      \textit{No subject specified.}
  }{
      \currentsubject
      \indexsubjects{\currentsubject}
  }

  \section*{Facts}
  \pgfkeysvalueof{/brief/facts}

  \section*{Procedural History}
  \pgfkeysvalueof{/brief/procedure}

  \section*{Issue}
  \pgfkeysvalueof{/brief/issue}

  \section*{Holding}
  \pgfkeysvalueof{/brief/holding}

  \section*{Reasoning}
  \pgfkeysvalueof{/brief/reasoning}

  \section*{Separate Opinions}
  \pgfkeysvalueof{/brief/opinions}
}
